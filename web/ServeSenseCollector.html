<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ServeSense ‚Äì Tennis Serve Data Collector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #222;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 2.2rem;
      font-weight: 700;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .subtitle {
      margin-bottom: 24px;
      color: rgba(255,255,255,0.9);
      font-size: 1rem;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px 24px;
      margin-bottom: 20px;
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 1.3rem;
      font-weight: 600;
      color: #667eea;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: #667eea;
      color: #fff;
      transition: all 0.2s;
    }
    button:hover { background: #5568d3; }
    button.secondary { background: #6b7280; }
    button.secondary:hover { background: #4b5563; }
    button.danger { background: #dc2626; }
    button.danger:hover { background: #b91c1c; }
    button.success { background: #16a34a; }
    button.success:hover { background: #15803d; }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    select, input[type="text"] {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #d4d4d8;
      font-size: 0.95rem;
      min-width: 200px;
    }
    #status {
      font-weight: 700;
      font-size: 1rem;
      padding: 6px 16px;
      border-radius: 20px;
      background: #fee2e2;
      color: #dc2626;
    }
    #status.ok {
      background: #dcfce7;
      color: #16a34a;
    }
    #debug {
      font-family: ui-monospace, Menlo, Consolas, "Roboto Mono", monospace;
      font-size: 0.8rem;
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
    }
    .charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    canvas {
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      width: 100%;
      height: 200px;
    }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      background: #e0e7ff;
      color: #3730a3;
      font-weight: 600;
    }
    .badge.recording {
      background: #fecaca;
      color: #991b1b;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px;
      background: #f9fafb;
      font-size: 0.9rem;
    }
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: white;
      border-radius: 6px;
      margin-bottom: 6px;
      border: 1px solid #e5e7eb;
    }
    .item:last-child {
      margin-bottom: 0;
    }
    .label-pill {
      padding: 4px 14px;
      border-radius: 20px;
      background: #dbeafe;
      color: #1e40af;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .stat-box {
      background: #f3f4f6;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-label {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéæ ServeSense Data Collector</h1>
    <div class="subtitle">
      Connect to your <strong>Xiao ESP32S3</strong>, record tennis serves with IMU data, and export
      <code>serve_data.json</code> for analysis and training.
    </div>

    <!-- Connection card -->
    <div class="card">
      <h2>1. Device Connection</h2>
      <div class="row">
        <button id="btnConnect">üîó Connect to ServeSense</button>
        <button id="btnDisconnect" class="secondary">Disconnect</button>
        <span id="status">Not Connected</span>
      </div>
      <div id="debug">[log] Ready. Click "Connect to ServeSense" to begin.</div>
    </div>

    <!-- Live Data card -->
    <div class="card">
      <h2>2. Live IMU Data</h2>
      <div class="stats">
        <div class="stat-box">
          <div class="stat-label">Accel X</div>
          <div class="stat-value" id="stat-ax">0.00g</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Accel Y</div>
          <div class="stat-value" id="stat-ay">0.00g</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Accel Z</div>
          <div class="stat-value" id="stat-az">0.00g</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Gyro X</div>
          <div class="stat-value" id="stat-gx">0¬∞/s</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Gyro Y</div>
          <div class="stat-value" id="stat-gy">0¬∞/s</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Gyro Z</div>
          <div class="stat-value" id="stat-gz">0¬∞/s</div>
        </div>
      </div>
      <div class="charts">
        <div>
          <canvas id="accelChart" width="400" height="200"></canvas>
          <div style="text-align:center; margin-top:6px; font-size:0.85rem; color:#6b7280; font-weight:600;">Accelerometer (g)</div>
        </div>
        <div>
          <canvas id="gyroChart" width="400" height="200"></canvas>
          <div style="text-align:center; margin-top:6px; font-size:0.85rem; color:#6b7280; font-weight:600;">Gyroscope (¬∞/s)</div>
        </div>
      </div>
    </div>

    <!-- Recording card -->
    <div class="card">
      <h2>3. Record a Serve</h2>
      <div class="row">
        <label>
          Serve Type:
          <select id="serveSelect">
            <option value="">-- Select Serve Type --</option>
            <option value="flat">Flat Serve</option>
            <option value="kick">Kick Serve</option>
            <option value="slice">Slice Serve</option>
            <option value="topspin">Topspin Serve</option>
            <option value="custom">/ Custom Label</option>
          </select>
        </label>
        <input type="text" id="customLabel" placeholder="Enter custom label" style="display:none;">
        <button id="btnStart" class="success">‚è∫ Start Recording</button>
        <button id="btnStop" class="danger" style="display:none;">‚èπ Stop Recording</button>
        <span id="recordInfo" class="badge">Idle</span>
      </div>
    </div>

    <!-- Summary / export -->
    <div class="card">
      <h2>4. Recorded Samples & Export</h2>
      <div class="row">
        <span id="summary" class="badge">0 samples recorded</span>
        <button id="btnExport">üíæ Download serve_data.json</button>
        <button id="btnClear" class="danger">üóë Clear All Data</button>
      </div>
      <div id="list" class="list"></div>
    </div>
  </div>

<script>
/* ==== ServeSense BLE Configuration ==== */
const DEVICE_NAME_PREFIX = "ServeSense";
const SERVICE_UUID       = 0xFF00;
const IMU_CHAR_UUID      = 0xFF01;  // notify: IMU packet
const CTRL_CHAR_UUID     = 0xFF02;  // write: 0x01 start, 0x00 stop

// Packet format: <IHH6fB3x (36 bytes)
// millis(4), session(2), seq(2), ax(4), ay(4), az(4), gx(4), gy(4), gz(4), flags(1), padding(3)
const PACKET_SIZE = 36;

/* ==== BLE Globals ==== */
let device  = null;
let imuChar = null;
let ctrlChar = null;

/* ==== Recording State ==== */
let isRecording = false;
let currentRecording = [];  // Array of {timestamp_ms, ax, ay, az, gx, gy, gz, ...}
let recordings = [];         // Array of completed recordings with labels

/* ==== Live Data ==== */
let accelHistory = { ax: [], ay: [], az: [] };
let gyroHistory = { gx: [], gy: [], gz: [] };
const MAX_HISTORY = 100;

/* ==== DOM Helpers ==== */
const $ = sel => document.querySelector(sel);

function log(msg) {
  const d = new Date().toLocaleTimeString();
  const el = $("#debug");
  el.textContent += `\n[${d}] ${msg}`;
  el.scrollTop = el.scrollHeight;
}

function setStatus(text, ok) {
  const el = $("#status");
  el.textContent = text;
  el.className = ok ? "ok" : "";
}

/* ==== Chart Drawing ==== */
function drawChart(canvasId, data, labels, colors, yMin, yMax) {
  const canvas = $(canvasId);
  const ctx = canvas.getContext("2d");
  const w = canvas.width;
  const h = canvas.height;
  
  ctx.clearRect(0, 0, w, h);
  
  // Grid
  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = (h / 4) * i;
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(w, y);
    ctx.stroke();
  }
  
  // Draw data
  const maxPoints = Math.max(...labels.map(l => data[l].length));
  if (maxPoints < 2) return;
  
  labels.forEach((label, idx) => {
    const points = data[label];
    if (points.length < 2) return;
    
    ctx.strokeStyle = colors[idx];
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    points.forEach((val, i) => {
      const x = (i / Math.max(maxPoints - 1, 1)) * w;
      const normalized = (val - yMin) / (yMax - yMin);
      const y = h - (normalized * h);
      
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    
    ctx.stroke();
  });
}

function updateCharts() {
  drawChart("#accelChart", accelHistory, ["ax", "ay", "az"], 
            ["#ef4444", "#10b981", "#3b82f6"], -4, 4);
  drawChart("#gyroChart", gyroHistory, ["gx", "gy", "gz"], 
            ["#f59e0b", "#8b5cf6", "#ec4899"], -500, 500);
}

/* ==== BLE Connect ==== */
async function connectBLE() {
  try {
    log("Requesting Bluetooth device‚Ä¶");
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: DEVICE_NAME_PREFIX }],
      optionalServices: [SERVICE_UUID]
    });

    device.addEventListener("gattserverdisconnected", onDisconnected);
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    imuChar = await service.getCharacteristic(IMU_CHAR_UUID);
    ctrlChar = await service.getCharacteristic(CTRL_CHAR_UUID);

    await imuChar.startNotifications();
    imuChar.addEventListener("characteristicvaluechanged", onIMU);

    setStatus(`Connected to ${device.name}`, true);
    log(`Connected to ${device.name}`);
    
    // Start streaming immediately
    await ctrlChar.writeValue(new Uint8Array([0x01]));
    log("Started IMU streaming");
    
  } catch (e) {
    log("Connect failed: " + e.message);
    setStatus("Not Connected", false);
  }
}

function onDisconnected() {
  log("Device disconnected.");
  setStatus("Not Connected", false);
  device = imuChar = ctrlChar = null;
  if (isRecording) {
    stopRecording();
  }
}

function disconnectBLE() {
  if (device && device.gatt.connected) {
    device.gatt.disconnect();
  }
}

/* ==== IMU Data Handler ==== */
function onIMU(event) {
  const dv = new DataView(event.target.value.buffer);
  
  if (dv.byteLength < PACKET_SIZE) {
    return;
  }
  
  // Parse packet
  const millis = dv.getUint32(0, true);
  const session = dv.getUint16(4, true);
  const seq = dv.getUint16(6, true);
  const ax = dv.getFloat32(8, true);
  const ay = dv.getFloat32(12, true);
  const az = dv.getFloat32(16, true);
  const gx = dv.getFloat32(20, true);
  const gy = dv.getFloat32(24, true);
  const gz = dv.getFloat32(28, true);
  const flags = dv.getUint8(32);
  
  // Update live display
  $("#stat-ax").textContent = ax.toFixed(2) + "g";
  $("#stat-ay").textContent = ay.toFixed(2) + "g";
  $("#stat-az").textContent = az.toFixed(2) + "g";
  $("#stat-gx").textContent = gx.toFixed(1) + "¬∞/s";
  $("#stat-gy").textContent = gy.toFixed(1) + "¬∞/s";
  $("#stat-gz").textContent = gz.toFixed(1) + "¬∞/s";
  
  // Update history
  accelHistory.ax.push(ax);
  accelHistory.ay.push(ay);
  accelHistory.az.push(az);
  gyroHistory.gx.push(gx);
  gyroHistory.gy.push(gy);
  gyroHistory.gz.push(gz);
  
  // Keep only recent data
  if (accelHistory.ax.length > MAX_HISTORY) {
    accelHistory.ax.shift();
    accelHistory.ay.shift();
    accelHistory.az.shift();
    gyroHistory.gx.shift();
    gyroHistory.gy.shift();
    gyroHistory.gz.shift();
  }
  
  updateCharts();
  
  // Record if active
  if (isRecording) {
    currentRecording.push({
      timestamp_ms: millis,
      session: session,
      sequence: seq,
      ax: ax,
      ay: ay,
      az: az,
      gx: gx,
      gy: gy,
      gz: gz,
      flags: flags
    });
    
    $("#recordInfo").textContent = `Recording ‚Ä¢ ${currentRecording.length} samples`;
    $("#recordInfo").className = "badge recording";
  }
}

/* ==== Recording Controls ==== */
function startRecording() {
  if (!device || !device.gatt || !device.gatt.connected) {
    alert("Connect to ServeSense first.");
    return;
  }
  
  const sel = $("#serveSelect").value;
  let label = sel === "custom" ? $("#customLabel").value.trim() : sel;
  if (!label) {
    alert("Select a serve type or enter a custom label.");
    return;
  }
  
  isRecording = true;
  currentRecording = [];
  startRecording.currentLabel = label;
  
  $("#btnStart").style.display = "none";
  $("#btnStop").style.display = "inline-block";
  $("#recordInfo").textContent = "Recording‚Ä¶";
  $("#recordInfo").className = "badge recording";
  
  log(`Started recording: ${label}`);
}

function stopRecording() {
  if (!isRecording) return;
  
  isRecording = false;
  $("#btnStart").style.display = "inline-block";
  $("#btnStop").style.display = "none";
  
  if (currentRecording.length === 0) {
    $("#recordInfo").textContent = "No data recorded.";
    $("#recordInfo").className = "badge";
    return;
  }
  
  const label = String(startRecording.currentLabel || "");
  const index = recordings.length;
  
  recordings.push({
    index: index,
    label: label,
    samples: currentRecording,
    timestamp: new Date().toISOString()
  });
  
  $("#recordInfo").textContent = `Saved "${label}" ‚Ä¢ ${currentRecording.length} samples`;
  $("#recordInfo").className = "badge";
  
  updateSummaryAndList();
  log(`Saved recording: ${label} (${currentRecording.length} samples)`);
  
  currentRecording = [];
}

function updateSummaryAndList() {
  $("#summary").textContent = `${recordings.length} samples recorded`;
  
  const list = $("#list");
  if (recordings.length === 0) {
    list.textContent = "No samples recorded yet. Connect and start recording!";
    return;
  }
  
  list.innerHTML = "";
  recordings.forEach(r => {
    const div = document.createElement("div");
    div.className = "item";
    const date = new Date(r.timestamp).toLocaleString();
    div.innerHTML = `
      <div>
        <span class="label-pill">${r.label}</span>
        <span style="margin-left:10px; color:#6b7280; font-size:0.85rem;">
          #${r.index} ‚Ä¢ ${r.samples.length} samples ‚Ä¢ ${date}
        </span>
      </div>
      <button class="danger" style="padding:6px 14px; font-size:0.85rem;"
        onclick="deleteRecording(${r.index})">Delete</button>`;
    list.appendChild(div);
  });
}

function deleteRecording(idx) {
  const i = recordings.findIndex(r => r.index === idx);
  if (i < 0) return;
  if (!confirm(`Delete recording #${idx} ("${recordings[i].label}")?`)) return;
  
  recordings.splice(i, 1);
  // Re-index
  recordings.forEach((r, k) => { r.index = k; });
  updateSummaryAndList();
  log(`Deleted recording #${idx}`);
}

function clearAll() {
  if (!confirm("Clear ALL recorded data? This cannot be undone.")) return;
  recordings = [];
  updateSummaryAndList();
  $("#recordInfo").textContent = "All data cleared. Idle.";
  $("#recordInfo").className = "badge";
  log("Cleared all recordings.");
}

/* ==== Export Data ==== */
function exportData() {
  if (recordings.length === 0) {
    alert("No data to export.");
    return;
  }
  
  const data = {
    device: "ServeSense",
    export_time: new Date().toISOString(),
    recordings: recordings.map(r => ({
      index: r.index,
      label: r.label,
      timestamp: r.timestamp,
      sample_count: r.samples.length,
      samples: r.samples
    }))
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  const date = new Date().toISOString().slice(0,10);
  a.download = `serve_data_${date}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  
  log(`Exported ${recordings.length} recordings to JSON`);
}

/* ==== Wire up UI ==== */
$("#btnConnect").addEventListener("click", connectBLE);
$("#btnDisconnect").addEventListener("click", disconnectBLE);
$("#btnStart").addEventListener("click", startRecording);
$("#btnStop").addEventListener("click", stopRecording);
$("#btnExport").addEventListener("click", exportData);
$("#btnClear").addEventListener("click", clearAll);

$("#serveSelect").addEventListener("change", (e) => {
  const showCustom = e.target.value === "custom";
  $("#customLabel").style.display = showCustom ? "inline-block" : "none";
});

setStatus("Not Connected", false);
updateSummaryAndList();
</script>
</body>
</html>
